// nextflow.config

/*
 * --- Project manifest (added) ---
 * Fill in homePage and authors as appropriate. Version is pinned for v1.0.0.
 */
manifest {
  name            = 'nf-nf-postgwas'
  mainScript      = 'main.nf'
  version         = '1.0.0'
  nextflowVersion = '>=25.10.0'
  description     = 'Post-GWAS Nextflow pipeline for loci compilation, LD, MAGMA, PoPS, colocalisation, prioritisation, and druggability.'
  homePage        = 'https://github.com/hlnicholls/nf-nf-postgwas'
  authors         = ['Hannah Nicholls']
}


profiles {
  standard { includeConfig 'conf/base.config' }
  local    { includeConfig 'conf/base.config'; includeConfig 'conf/local.config' }
  hpc      { includeConfig 'conf/base.config'; includeConfig 'conf/hpc.config' }
  test     { includeConfig 'conf/base.config'; includeConfig 'conf/test.config' }
}

params {
  // Defaults (your -params-file will override these)
  traits       = ['trait1', 'trait2']
  sample_sizes = [1000, 1000]

  // Genome build default
  genome_build = 'GRCh38'

  // Paths
  home_path   = '/nf-postgwas'
  output_path = '/nf-postgwas/results'
  databases   = '/nf-postgwas/databases/'

  // Reference panel for LD calculation (REQUIRED; your -params-file should point this to a real panel)
  ld_reference_panel = "${databases}/1000genomes/fake_imputation"

  // Genetic map for recombination rates (regional plots) - optional
  genetic_map_hg38 = null

  // Inputs
  gwas_input_dir = "${home_path}/GWAS_Input"
  input_suffix   = '_regenie_allchr.txt'

  // NF reports/output root
  outdir = "${output_path}"

  script_root = "${home_path}"
  output_root = '/nf-postgwas'

  // Colocalisation defaults
  run_coloc         = true
  run_hf_coloc      = false
  run_dcm_coloc     = false
  run_custom_coloc  = false
  custom_trait_name = 'MyTrait'
  custom_gwas_path  = ''
  gtex_tissues      = ['Artery_Aorta', 'Artery_Coronary', 'Heart_Atrial_Appendage', 'Heart_Left_Ventricle']

  // Variant annotation defaults
  run_vep = false  // VEP requires Docker setup

  // Fine-mapping parameters
  fine_mapping_method = 'wakefield'

  // MAGMA parameters
  magma_memory = '5 GB'
  magma_cpus   = 2
  magma_bin    = 'magma'   // default to silence undefined-parameter warning

  // PoPS parameters
  pops_python       = 'python3'
  pops_script       = '/nf-postgwas/databases/pops/pops.py'
  pops_annot        = '/nf-postgwas/databases/pops/example/data/utils/gene_annot_jun10.txt'
  pops_features_all = '/nf-postgwas/databases/pops/features_munged_all/pops_features_all'
  pops_control      = '/nf-postgwas/databases/pops/example/data/utils/features_jul17_control.txt'

  // ===== Global resource cap =====
  max_memory = '14 GB'

  // ===== LD-specific knobs (read inside CALC_LD script) =====
  ld_memory        = null      // e.g. '12 GB'; if null, uses max_memory
  ld_cpus          = 2         // Nextflow task CPUs for CALC_LD
  ld_parallel_jobs = 2         // exported by process script as MAX_PARALLEL
  plink_threads    = null      // optional; if null, script uses task.cpus
  plink_mem_mb     = null      // optional; if null, script derives from task.memory

  // PLINK LD window (user-tunable)
  ld_window_kb = 4000
  ld_window_r2 = 0.1
  ld_window    = 99999

  // Optional: enforce a Docker memory limit (e.g., '14g'). Leave empty to skip.
  container_memory = '14g'

  // LDSC: explicit Python 2.7 interpreter (inside your Docker image)
  // NOTE: this must match the conda env name created inside the Docker image
  // The environment YAML supplied in the repo is named `postgwas_py27` by default.
  py27_env_name  = 'postgwas_py27'
  py27_python    = '/opt/conda/envs/postgwas_py27/bin/python'
}

// Concurrency / batching and defaults
process {
  // safe default cap for all processes unless overridden
  withName: /.*/ {
    memory = params.max_memory
  }

  // prep batching (example label used elsewhere in your pipeline)
  withLabel: prep_batch5 {
    maxForks = 5
    cpus     = 1
    memory   = '6 GB'
  }

  // LD calc: just set resources here; pass all runtime knobs inside the process script
  withLabel: 'heavy' {
    memory = params.ld_memory ? params.ld_memory : params.max_memory
    cpus   = params.ld_cpus
    errorStrategy = 'retry'
    maxRetries    = 2
  }

  // MAGMA via stable label
  withLabel: 'magma' {
    memory        = params.magma_memory
    cpus          = params.magma_cpus
    errorStrategy = 'retry'
    maxRetries    = 1
  }
}

// Docker runtime limits
docker {
  enabled    = true
  runOptions = params.container_memory ? "-m ${params.container_memory} --memory-swap ${params.container_memory}" : ''
}

// Reports
report   { enabled = true; overwrite = true }
timeline { enabled = true; overwrite = true }
dag      { enabled = true; overwrite = true }
trace    { enabled = true; overwrite = true }
